/**
 * This ruleset implements a Role-Based Access Control (RBAC) model for the PrimeForage application.
 *
 * Core Philosophy:
 * The security model is centered around a privileged 'admin' role. Users designated as admins are granted
 * read-only access to application-wide data, such as the list of registered teams. All other users,
 * including authenticated non-admins and anonymous users, are denied access. All write operations
 * (create, update, delete) are disallowed from the client-side, implying that data is managed by a
 * trusted server environment (e.g., Cloud Functions).
 *
 * Data Structure:
 * The data is organized into distinct top-level collections:
 * - /teams/{teamId}: Stores information about registered teams.
 * - /sponsors/{sponsorId}: Stores information about tournament sponsors.
 * - /roles_admin/{userId}: A lookup collection where the existence of a document grants a user admin privileges.
 *
 * Key Security Decisions:
 * - Admin-Only Reads: Only users with a corresponding document in the /roles_admin collection can read from the /teams collection.
 * - Public Reads for Sponsors: The /sponsors collection is publicly readable by anyone, as this information is displayed on the main page.
 * - Admin-Only Writes: Only admins can create, update, or delete documents in the /sponsors collection.
 * - No Client-Side Writes on Teams: To ensure data integrity and prevent unauthorized modifications, all write operations on the /teams collection are disabled for clients.
 * - Secure Role Management: The /roles_admin collection is completely locked down from client access to prevent users from escalating their own privileges. Roles must be managed through the Firebase Console or a secure backend process.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user has an admin role.
     * This is determined by the existence of a document in the 'roles_admin'
     * collection with the user's UID as the document ID.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }


    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description
     *   Manages access to team registration data. Any authenticated user can
     *   read this information. All client-side write operations are
     *   denied to ensure data is only created or modified by a trusted backend.
     * @path /teams/{teamId}
     * @allow An authenticated user `(get)`s or `(list)`s team documents.
     * @deny A non-admin signed-in user tries to `(create)` a team document.
     * @principle Implements simple access control for reads and prevents all client-side writes.
     */
    match /teams/{teamId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     *   Manages sponsor data. This data is public to read for the landing page,
     *   but all write operations are restricted to authenticated admins.
     * @path /sponsors/{sponsorId}
     * @allow Any user can `(get)` or `(list)` sponsors.
     * @allow An authenticated admin can `(create)`, `(update)`, `(delete)` a sponsor.
     * @deny A non-admin user tries to `(create)` a sponsor.
     */
    match /sponsors/{sponsorId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description
     *   Secures the collection that defines admin roles. This collection is used
     *   as a lookup table by other security rules (`isAdmin()` function) and
     *   must not be readable or writable by any client to prevent privilege escalation.
     * @path /roles_admin/{userId}
     * @allow No direct client access is permitted.
     * @deny Any user (including an admin) trying to `(get)`, `(create)`, or `(delete)` a role document.
     * @principle Prevents client-side tampering with authorization roles.
     */
    match /roles_admin/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}